@page "/TaskManager"
@attribute [Authorize]

@using DataMarkup.Entities.Views
@using DataMarkup.Frontend.Extensions
@using DataMarkup.Frontend.Models
@using Task = System.Threading.Tasks.Task

@inject ApiHttpClient ApiHttpClient;

<h3 class="fw-bold">Task Manager</h3>

<div class="container-fluid mt-3">
    @foreach (var taskTypesRow in _taskTypes
        .Select(taskType => new TaskTypeCard
        {
            Title = taskType.Name,
            Subtitle = $"payment: {taskType.Payment}, max solutions: {taskType.SolutionsCount}",
            TextArea = taskType.Instruction.CutIfMoreThan(70),
            ButtonText = "To task",
            ButtonHref = $"/TaskManager/get-task-type/{taskType.Id}"
        })
        .Prepend(new TaskTypeCard
        {
            Title = "New task",
            Subtitle = string.Empty,
            TextArea = "Instruction preview...",
            ButtonText = "Create",
            ButtonHref = "/TaskManager/add-task-type"
        })
        .Select((taskType, index) => (taskType, index))
        .GroupBy(pair => pair.index / 4))
    {
        <div class="row mb-3">
            @foreach (var (taskTypeCard, _) in taskTypesRow)
            {
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title fw-bold">@taskTypeCard.Title</h5>
                            <h6 class="card-subtitle">@taskTypeCard.Subtitle</h6>
                            <p class="card-text">@taskTypeCard.TextArea</p>
                            <a class="btn btn-secondary" href="@taskTypeCard.ButtonHref">
                                @taskTypeCard.ButtonText
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private IReadOnlyCollection<TaskType> _taskTypes = ArraySegment<TaskType>.Empty;

    protected override async Task OnInitializedAsync()
    {
        var taskTypesResult = await ApiHttpClient.GetTaskTypesAsync();

        _taskTypes = taskTypesResult!.Successful ?
            taskTypesResult.TaskTypes :
            Array.Empty<TaskType>();

        await base.OnInitializedAsync();
    }

    private record TaskTypeCard : Card
    {
        public string ButtonHref { get; init; } = null!;
    }
}